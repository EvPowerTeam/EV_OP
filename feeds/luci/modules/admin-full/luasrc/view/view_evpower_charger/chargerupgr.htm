<%#
LuCI - Lua Configuration Interface
Copyright 2008 Steven Barth <steven@midlink.org>
Copyright 2008 Jo-Philipp Wich <xm@leipzig.freifunk.net>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

$Id$

-%>

<%+header%>


<fieldset class="cbi-section">
	<h2>电桩固件升级</h2>
	
	<fieldset class="cbi-section">
		<legend><%:电桩固件总览%></legend>
	   <table class="cbi-section-table">
		<tr class="cbi-section-table-titles">
			<th class="cbi-section-table-cell"><%:电桩ID%></th>
			<th class="cbi-section-table-cell"><%:目前FW版本号%></th>
			<th class="cbi-section-table-cell"><%:更新时间%></th>
		</tr>
		<tr class="cbi-section-table-row">
			<td align="left"><%=luci.sys.exec("uci get chargerinfo.charger1.CID")%></td>
			<td align="left"><%=luci.sys.exec("uci get chargerinfo.charger1.ChargerVersion")%></td>
			<td align="left" id="charger1"><%=luci.sys.exec("uci get chargerinfo.charger1.FW_END_TIME")%></td>
		</tr>
		<tr class="cbi-section-table-row">
			<td align="left"><%=luci.sys.exec("uci get chargerinfo.charger2.CID")%></td>
			<td align="left"><%=luci.sys.exec("uci get chargerinfo.charger2.ChargerVersion")%></td>
			<td align="left" id="charger2"><%=luci.sys.exec("uci get chargerinfo.charger2.FW_END_TIME")%></td>
		</tr>
		<tr class="cbi-section-table-row">
			<td align="left"><%=luci.sys.exec("uci get chargerinfo.charger3.CID")%></td>
			<td align="left"><%=luci.sys.exec("uci get chargerinfo.charger3.ChargerVersion")%></td>
			<td align="left" id="charger3"><%=luci.sys.exec("uci get chargerinfo.charger3.FW_END_TIME")%></td>
		</tr>
		<tr class="cbi-section-table-row">
			<td align="left"><%=luci.sys.exec("uci get chargerinfo.charger4.CID")%></td>
			<td align="left"><%=luci.sys.exec("uci get chargerinfo.charger4.ChargerVersion")%></td>
			<td align="left" id="charger4"><%=luci.sys.exec("uci get chargerinfo.charger4.FW_END_TIME")%></td>
		</tr>
		<tr class="cbi-section-table-row">
			<td align="left"><%=luci.sys.exec("uci get chargerinfo.charger5.CID")%></td>
			<td align="left"><%=luci.sys.exec("uci get chargerinfo.charger5.ChargerVersion")%></td>
			<td align="left" id="charger5"><%=luci.sys.exec("uci get chargerinfo.charger5.FW_END_TIME")%></td>
		</tr>
		<tr class="cbi-section-table-row">
			<td align="left"><%=luci.sys.exec("uci get chargerinfo.charger6.CID")%></td>
			<td align="left"><%=luci.sys.exec("uci get chargerinfo.charger6.ChargerVersion")%></td>
			<td align="left" id="charger6"><%=luci.sys.exec("uci get chargerinfo.charger6.FW_END_TIME")%></td>
		</tr>
		<tr class="cbi-section-table-row">
			<td align="left"><%=luci.sys.exec("uci get chargerinfo.charger7.CID")%></td>
			<td align="left"><%=luci.sys.exec("uci get chargerinfo.charger7.ChargerVersion")%></td>
			<td align="left" id="charger7"><%=luci.sys.exec("uci get chargerinfo.charger7.FW_END_TIME")%></td>
		</tr>
		<tr class="cbi-section-table-row">
			<td align="left"><%=luci.sys.exec("uci get chargerinfo.charger8.CID")%></td>
			<td align="left"><%=luci.sys.exec("uci get chargerinfo.charger8.ChargerVersion")%></td>
			<td align="left" id="charger8"><%=luci.sys.exec("uci get chargerinfo.charger8.FW_END_TIME")%></td>
		</tr>
	   </table>
	</fieldset>
	
	<fieldset class="cbi-section">
		<legend><%:更新电桩固件%></legend>
		<form id="upgr" name="upgr" action="<%=luci.dispatcher.build_url("admin","evpower","chargerfw")%>"method="post" enctype="multipart/form-data">
			<input type="hidden" name="act" value="update" />
			<input type="file" id="updatePackage" name="updatePackage" />
			<input type="submit" id="updateBtn" class="cbi-button cbi-button-apply" value="上传" />
		</form>
		<input type="button" class="cbi-button cbi-button-apply" value="<%:电桩FW更新时间%>" onclick="return fw_lasttime(this)" />
	</fieldset>

</fieldset>


<script type="text/javascript">//<![CDATA[

	function fw_lasttime(is_time)
	{
		var lsfile = <%= luci.sys.exec("ls /mnt/umemory/power_bar/UPDATE/ | wc -l")%>
		console.log(lsfile);
		if( lsfile > 0 )
		{
			XHR.get('<%=luci.dispatcher.build_url("admin","evpower","fwuptime")%>',
			{is_time:Math.floor((new Date()).getTime()/1000)},
			function()
			{}
			);
		}
		window.location.href = '<%=luci.dispatcher.build_url("admin","evpower","upgrade")%>';
		return;
	}
	
	var pre1 = <%=luci.sys.exec("uci get chargerinfo.charger1.FW_END_TIME")%>
	console.log(pre1)
	pre1 =+ pre1;
	var pretim1 = new Date(pre1*1000)
	var pretime1 = pretim1.toLocaleString()
	console.log(pretime1)
	document.getElementById("charger1").innerText=pretime1;
	
	var pre2 = <%=luci.sys.exec("uci get chargerinfo.charger2.FW_END_TIME")%>
	console.log(pre2)
	pre2 =+ pre2;
	var pretim2 = new Date(pre2*1000)
	var pretime2 = pretim2.toLocaleString()
	console.log(pretime2)
	document.getElementById("charger2").innerText=pretime2;
	
	var pre3 = <%=luci.sys.exec("uci get chargerinfo.charger3.FW_END_TIME")%>
	console.log(pre3)
	pre3 =+ pre3;
	var pretim3 = new Date(pre3*1000)
	var pretime3 = pretim3.toLocaleString()
	console.log(pretime3)
	document.getElementById("charger3").innerText=pretime3;
	
	var pre4 = <%=luci.sys.exec("uci get chargerinfo.charger4.FW_END_TIME")%>
	console.log(pre4)
	pre4 =+ pre4;
	var pretim4 = new Date(pre4*1000)
	var pretime4 = pretim4.toLocaleString()
	console.log(pretime4)
	document.getElementById("charger4").innerText=pretime4;

	var pre5 = <%=luci.sys.exec("uci get chargerinfo.charger5.FW_END_TIME")%>
	console.log(pre5)
	pre5 =+ pre5;
	var pretim5 = new Date(pre5*1000)
	var pretime5 = pretim5.toLocaleString()
	console.log(pretime5)
	document.getElementById("charger5").innerText=pretime5;
	
	var pre6 = <%=luci.sys.exec("uci get chargerinfo.charger6.FW_END_TIME")%>
	console.log(pre6)
	pre6 =+ pre6;
	var pretim6 = new Date(pre6*1000)
	var pretime6 = pretim6.toLocaleString()
	console.log(pretime6)
	document.getElementById("charger6").innerText=pretime6;
	
	var pre7 = <%=luci.sys.exec("uci get chargerinfo.charger7.FW_END_TIME")%>
	console.log(pre7)
	pre7 =+ pre7;
	var pretim7 = new Date(pre7*1000)
	var pretime7 = pretim7.toLocaleString()
	console.log(pretime7)
	document.getElementById("charger7").innerText=pretime7;
	
	var pre = <%=luci.sys.exec("uci get chargerinfo.charger8.FW_END_TIME")%>
	console.log(pre)
	pre =+ pre;
	var pretim = new Date(pre*1000)
	var pretime = pretim.toLocaleString()
	console.log(pretime)
	document.getElementById("charger8").innerText=pretime;
//]]></script>

<%+footer%>
